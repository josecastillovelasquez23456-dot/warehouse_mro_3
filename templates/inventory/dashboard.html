{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid mt-4">

    <!-- T√çTULO -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold mb-0">üìä Panel General de Inventarios MRO</h2>
        <div>
            <a href="{{ url_for('inventory.upload_inventory') }}" class="btn btn-sm btn-outline-primary me-2">
                üì• Cargar Inventario Base
            </a>
            <a href="{{ url_for('inventory.upload_inventory_history') }}" class="btn btn-sm btn-outline-secondary">
                üïí Subir Inventario Hist√≥rico
            </a>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">Total √çtems</div>
                    <div class="display-6 fw-bold text-primary">{{ total_items }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">Stock Total</div>
                    <div class="display-6 fw-bold text-success">{{ total_stock }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">Ubicaciones</div>
                    <div class="display-6 fw-bold text-info">{{ ubicaciones }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">Promedio por √çtem</div>
                    <div class="display-6 fw-bold text-warning">{{ stock_prom }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- FILA CENTRAL: HEATMAP + ALERTAS -->
    <div class="row g-3 mb-4">

        <!-- HEATMAP UBICACIONES -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-dark text-white">
                    üî• Mapa de calor por ubicaci√≥n
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap">
                        {% for r in resumen %}
                            {% set s = r.stock %}
                            {% if s <= 5 %}
                                {% set color = "#dc3545" %}
                            {% elif s <= 20 %}
                                {% set color = "#fd7e14" %}
                            {% else %}
                                {% set color = "#198754" %}
                            {% endif %}
                            <div class="me-2 mb-2 text-center"
                                 style="min-width:85px; border-radius:10px; padding:8px 6px; color:white; background:{{ color }};">
                                <div class="fw-bold">{{ r.location }}</div>
                                <small>{{ s }} u.</small>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ALERTAS -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-danger text-white">
                    ‚ö†Ô∏è √öltimas alertas
                </div>
                <div class="card-body" style="max-height:300px; overflow-y:auto;">
                    {% if alertas %}
                        <ul class="list-group list-group-flush">
                            {% for a in alertas %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <span class="badge bg-outline">
                                            {{ a.severity or a.nivel }}
                                        </span>
                                        <small class="text-muted">{{ a.fecha }}</small>
                                    </div>
                                    <div class="fw-bold small mt-1">
                                        {{ a.tipo or a.alert_type }}
                                    </div>
                                    <div class="small">
                                        {{ a.mensaje or a.message }}
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">Sin alertas recientes.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- FILA INFERIOR: GR√ÅFICO + SNAPSHOTS + CR√çTICOS -->
    <div class="row g-3 mb-5">

        <!-- GR√ÅFICO BARRAS -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    üì¶ Stock total por ubicaci√≥n
                </div>
                <div class="card-body">
                    <canvas id="stockChart" height="120"></canvas>
                </div>
            </div>
        </div>

        <!-- HIST√ìRICOS & CR√çTICOS -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-secondary text-white">
                    üïí Inventarios hist√≥ricos
                </div>
                <div class="card-body" style="max-height:180px; overflow-y:auto;">
                    {% if snapshots %}
                        {% for s in snapshots %}
                            <div class="border rounded p-2 mb-2 bg-light">
                                <div class="fw-bold small">{{ s.snapshot_name }}</div>
                                <small class="text-muted d-block">
                                    {{ s.fecha }}
                                </small>
                                <small class="text-muted d-block">
                                    ID: {{ s.snapshot_id }}
                                </small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">A√∫n no se han cargado snapshots hist√≥ricos.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning">
                    üîª Materiales cr√≠ticos (‚â§5 u.)
                </div>
                <div class="card-body" style="max-height:180px; overflow-y:auto;">
                    {% if criticos %}
                        <ul class="list-group list-group-flush">
                            {% for c in criticos %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold small">{{ c.material_code }}</div>
                                        <small class="text-muted">{{ c.material_text }}</small><br>
                                        <small class="badge bg-light text-dark">Ub: {{ c.location }}</small>
                                    </div>
                                    <span class="badge bg-danger rounded-pill">
                                        {{ c.libre_utilizacion }}
                                    </span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">No hay materiales cr√≠ticos.</p>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

<script>
const labels = [
    {% for r in resumen %}
        "{{ r.location }}",
    {% endfor %}
];

const dataStock = [
    {% for r in resumen %}
        {{ r.stock }},
    {% endfor %}
];

const ctx = document.getElementById('stockChart');
if (ctx) {
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Stock total',
                data: dataStock,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}
</script>

{% endblock %}
