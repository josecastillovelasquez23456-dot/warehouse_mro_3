{% extends "base.html" %}
{% block content %}

<h2 class="fw-bold mb-4">
    <i class="bi bi-pen me-2"></i> Conteo de Inventario
</h2>

<div class="card shadow-sm p-3">

    <div class="d-flex justify-content-between mb-3">

        <input type="text" id="searchCount" class="form-control w-50"
               placeholder="üîç Buscar material, texto o ubicaci√≥n...">

        <button id="saveCountBtn" class="btn btn-success">
            <i class="bi bi-check2-circle me-2"></i> Guardar Conteo
        </button>

    </div>

    <div class="table-responsive">
        <table class="table table-striped" id="countTable">
            <thead class="table-dark">
                <tr>
                    <th>C√≥digo</th>
                    <th>Descripci√≥n</th>
                    <th>Ubicaci√≥n</th>
                    <th>Stock Sistema</th>
                    <th>Conteo Real</th>
                </tr>
            </thead>

            <tbody>
                {% for i in items %}
                <tr data-code="{{ i.material_code }}" data-loc="{{ i.location }}">
                    <td>{{ i.material_code }}</td>
                    <td>{{ i.material_text }}</td>
                    <td>{{ i.location }}</td>
                    <td>{{ i.libre_utilizacion }}</td>
                    <td>
                        <input type="number" min="0" class="form-control count-input"
                               placeholder="Ingresar conteo...">
                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>

</div>

<script>
// üîç Filtro de b√∫squeda
document.getElementById("searchCount").addEventListener("keyup", function () {
    let filter = this.value.toLowerCase();
    document.querySelectorAll("#countTable tbody tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
});


// üìù GUARDAR TODO EL CONTEO
document.getElementById("saveCountBtn").addEventListener("click", () => {

    let conteos = [];

    document.querySelectorAll("#countTable tbody tr").forEach(row => {
        let codigo = row.getAttribute("data-code");
        let ubic = row.getAttribute("data-loc");
        let input = row.querySelector(".count-input").value;

        if (input !== "") {
            conteos.push({
                codigo: codigo,
                ubicacion: ubic,
                real: Number(input),
            });
        }
    });

    if (conteos.length === 0) {
        alert("‚ö† No llenaste ning√∫n conteo.");
        return;
    }

    // Enviar conteos al backend
    fetch("/inventory/save-count", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(conteos)
    })
    .then(r => r.json())
    .then(data => {
        alert("‚úÖ Conteo guardado correctamente");
    })
    .catch(err => alert("‚ùå Error guardando conteo"));
});
</script>

{% endblock %}
